---
name: Build and Deploy Docker Image
on:
  push:
    branches: [ 'master' ]
  workflow_dispatch: null
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.18.3

      - name: Install dependencies and build
        run: |
          pnpm install --frozen-lockfile
          pnpm build
          NODE_ENV=production DOCKER_BUILD=true pnpm --filter=n8n --prod --legacy deploy --no-optional ./compiled
          NODE_ENV=production DOCKER_BUILD=true pnpm --filter=@n8n/task-runner --prod --legacy deploy --no-optional ./dist/task-runner-javascript

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GH_CI_TOKEN }}

      - name: Preset Image Name
        run: |
          echo "IMAGE_URL=$(echo "ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ github.ref_name }}-$(echo "${{ github.sha }}" | cut -c1-7)" | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_ENV"

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/images/n8n/Dockerfile
          push: true
          tags: ${{ env.IMAGE_URL }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            TARGETPLATFORM=linux/amd64

  deploy_prod:
    needs: [build]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    environment: prod
    steps:
      - name: Preset Image tag
        run: |
          echo "IMAGE_TAG=$(echo "${{ github.ref_name }}-$(echo "${{ github.sha }}" | cut -c1-7)" | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_ENV"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Install envsubst
        run: |
          sudo apt-get update
          sudo apt-get install -y gettext-base

      - name: Deploy production
        run: |
          mkdir -p ~/.kube
          echo "${{secrets.K8S_ADMIN_CONFIG}}" > ~/.kube/config
          echo "${{vars.ENVS}}" > .deploy/kustomize/prod/.env.vars
          cat << 'EOF' > .deploy/kustomize/prod/GOOGLE_PRIVATE_KEY
          ${{vars.GOOGLE_PRIVATE_KEY}}
          EOF
          cat << 'EOF' > .deploy/kustomize/prod/YANDEX_PRIVATE_KEY
          ${{vars.YANDEX_PRIVATE_KEY}}
          EOF
          cat << 'EOF' > .deploy/kustomize/prod/YANDEX_PUBLIC_KEY
          ${{vars.YANDEX_PUBLIC_KEY}}
          EOF
          export IMAGE_TAG=$IMAGE_TAG
          export INGRESS_HOST=${{vars.INGRESS_HOST}}
          kubectl create secret docker-registry ghcr-login-secret \
            --docker-server='ghcr.io' \
            --docker-username=${{ github.repository_owner }} \
            --docker-password=${{ secrets.GH_CI_TOKEN }} \
            --docker-email="${{ github.repository_owner }}@ailab.im" \
            -n ailab \
            --dry-run=client -o yaml | kubectl apply -f -
          envsubst < .deploy/kustomize/prod/kustomization.yaml > prod-kustomization.yaml && mv -f prod-kustomization.yaml .deploy/kustomize/prod/kustomization.yaml
          envsubst < .deploy/kustomize/prod/ingress.yaml > prod-ingress.yaml && mv -f prod-ingress.yaml .deploy/kustomize/prod/ingress.yaml
          kubectl apply -k .deploy/kustomize/prod
          rm -f ~/.kube/config

      - name: Wait for rollout
        run: |
          mkdir -p ~/.kube
          echo "${{secrets.K8S_ADMIN_CONFIG}}" > ~/.kube/config
          kubectl rollout status deployment/botassist-n8n-main -n ailab --timeout=600s
          kubectl rollout status deployment/botassist-n8n-worker -n ailab --timeout=600s
          rm -f ~/.kube/config

      - name: Deployment status
        if: always()
        run: |
          mkdir -p ~/.kube
          echo "${{secrets.K8S_ADMIN_CONFIG}}" > ~/.kube/config
          kubectl get pods -n ailab | grep botassist-n8n
          rm -f ~/.kube/config
